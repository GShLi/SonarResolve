# JIRA任务创建限制配置

## 概述

为了避免一次性创建过多的JIRA任务导致系统负载过高或处理时间过长，我们新增了 `JIRA_MAX_TASKS_PER_RUN` 配置项来限制单次运行时创建的JIRA任务数量。

## 配置参数

### JIRA_MAX_TASKS_PER_RUN

**描述**: 单次运行创建JIRA任务的最大数量限制

**类型**: 整数

**默认值**: 50

**可选值**:
- `0`: 无限制，会处理所有发现的Critical问题
- `> 0`: 限制单次运行创建的JIRA任务数量

## 配置方法

### 1. 环境变量配置

在 `.env` 文件中添加:
```bash
# 单次运行创建JIRA任务的最大数量限制（0表示无限制）
JIRA_MAX_TASKS_PER_RUN=50
```

### 2. 推荐配置值

- **开发环境**: 10-20个任务，便于快速测试
- **生产环境**: 50-100个任务，平衡处理效率和系统负载
- **初次部署**: 10个任务，确保系统稳定运行
- **无限制模式**: 0，适用于离线批处理场景

## 工作机制

### 1. 任务创建流程

1. 系统获取所有SonarQube Critical问题
2. 按项目分组处理
3. 对每个项目：
   - 检查已创建的任务数量
   - 如果达到限制，停止创建更多任务
   - 记录剩余未处理的问题数量

### 2. 限制生效时机

```python
# 在 JiraClient.create_issues_from_sonar() 方法中
for i, sonar_issue in enumerate(sonar_issues, 1):
    # 检查是否达到任务创建限制
    if max_tasks > 0 and len(created_issues) >= max_tasks:
        logger.warning(f"已达到单次创建任务限制 ({max_tasks} 个)")
        break
    # 继续创建任务...
```

### 3. 日志输出

系统会在以下时机输出相关日志：

```
当前配置信息:
  - JIRA任务创建限制: 50 个/次
  - JIRA任务前缀: [质量管理]
  - 包含代码片段: True

设置了单次创建任务限制: 50 个任务
创建第 1/120 个Jira任务...
...
已达到单次创建任务限制 (50 个)，停止创建更多任务
剩余 70 个问题将在下次运行时处理
```

## 报告功能

### 1. 批量处理报告

报告中会包含配置信息：

```
配置信息:
- 单次任务创建限制: 50 个
- 任务前缀: [质量管理]
- 包含代码片段: 是

问题处理统计:
- 发现Critical问题总数: 120 个
- 创建Jira任务总数: 50 个
- 任务创建率: 41.7%
```

### 2. 处理建议

当任务创建率较低时，报告会提示：
- 是否需要调整限制数量
- 剩余问题的处理建议
- 下次运行的预期结果

## 使用场景

### 1. 初次部署

```bash
# 保守配置，确保系统稳定
JIRA_MAX_TASKS_PER_RUN=10
```

### 2. 日常维护

```bash
# 平衡配置，适合定期运行
JIRA_MAX_TASKS_PER_RUN=50
```

### 3. 批量处理

```bash
# 高效配置，适合离线处理
JIRA_MAX_TASKS_PER_RUN=100
```

### 4. 无限制模式

```bash
# 处理所有问题，适合一次性清理
JIRA_MAX_TASKS_PER_RUN=0
```

## 注意事项

### 1. 性能考虑

- 任务数量过多可能导致JIRA API限制
- 建议根据JIRA实例性能调整限制
- 监控任务创建的响应时间

### 2. 业务影响

- 限制过低可能导致Critical问题处理不及时
- 建议根据团队工作负载调整
- 考虑与CI/CD流程的集成频率

### 3. 缓存机制

- 系统会记录已创建的任务，避免重复创建
- 下次运行时会继续处理剩余问题
- 缓存数据存储在SQLite数据库中

## 故障排除

### 1. 配置不生效

检查环境变量是否正确设置：
```bash
echo $JIRA_MAX_TASKS_PER_RUN
```

### 2. 任务创建停止

查看日志确认是否达到限制：
```
已达到单次创建任务限制 (50 个)，停止创建更多任务
```

### 3. 性能问题

如果遇到性能问题，可以：
- 降低限制数量
- 增加处理间隔
- 监控JIRA API响应时间

## 版本历史

- **v1.0**: 初始版本，支持基本任务数量限制
- 默认限制: 50个任务
- 支持无限制模式（设置为0）
